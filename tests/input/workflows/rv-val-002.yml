project-dir: rv-val-002
config: rv-val.toml

test:
  steps:
  - name: "Start R"
    run: "R"
    thread: r
  
  - name: "Create sample renv project"
    run: |
      # Create a realistic renv.lock file manually
      renv_lock_content <- '{
        "R": {
          "Version": "4.4",
          "Repositories": [
            {
              "Name": "CRAN",
              "URL": "https://cran.rstudio.com"
            }
          ]
        },
        "Packages": {
          "dplyr": {
            "Package": "dplyr",
            "Version": "1.1.4",
            "Source": "Repository",
            "Repository": "CRAN",
            "Requirements": [
              "R", "cli", "glue", "lifecycle", "magrittr", "rlang", "tibble", "tidyselect", "vctrs"
            ]
          },
          "ggplot2": {
            "Package": "ggplot2", 
            "Version": "3.5.2",
            "Source": "Repository",
            "Repository": "CRAN",
            "Requirements": [
              "R", "cli", "glue", "gtable", "isoband", "lifecycle", "rlang", "scales", "tibble", "vctrs", "withr"
            ]
          },
          "jsonlite": {
            "Package": "jsonlite",
            "Version": "2.0.0",
            "Source": "Repository", 
            "Repository": "CRAN",
            "Requirements": [
              "R", "methods"
            ]
          }
        }
      }'
      
      # Write the renv.lock file with proper file handling
      renv_conn <- file("renv.lock", "w")
      writeLines(renv_lock_content, renv_conn)
      flush(renv_conn)
      close(renv_conn)
      
      # Create basic .Rprofile for renv with proper file handling
      rprofile_conn <- file(".Rprofile", "w")
      writeLines("source(\"renv/activate.R\")", rprofile_conn)
      flush(rprofile_conn)
      close(rprofile_conn)
      
      # Verify files were created
      cat("Created files:", paste(list.files("."), collapse=", "), "\n")
      cat("renv.lock exists:", file.exists("renv.lock"), "\n")
    thread: r
    assert: "renv.lock exists: TRUE"

  - name: "Migrate renv project using rv"  
    run: "rv migrate renv"
    thread: rv
    assert: "renv.lock was successfully migrated to rproject.toml" 
